{
  "kind": "implementation_plan",
  "version": "1.0",
  "title": "Fix infinite render loop and React Query refetch issues",
  "requirements": [
    {
      "id": "REQ-97",
      "summary": "Disable aggressive background refetching in useGetCallerUserProfile hook to prevent infinite query loop",
      "acceptanceCriteria": [
        "useGetCallerUserProfile hook includes refetchOnWindowFocus: false",
        "useGetCallerUserProfile hook includes refetchOnReconnect: false",
        "useGetCallerUserProfile hook includes staleTime set to at least 300000ms (5 minutes)",
        "Profile fetching no longer triggers repeatedly in console logs"
      ],
      "file_operations": [
        {
          "path": "frontend/src/hooks/useQueries.ts",
          "operation": "modify",
          "description": "Update the useGetCallerUserProfile hook's useQuery configuration to add refetchOnWindowFocus: false, refetchOnReconnect: false, and staleTime: 300000 (5 minutes) to prevent aggressive background refetching that causes the infinite query loop"
        }
      ]
    },
    {
      "id": "REQ-98",
      "summary": "Disable aggressive background refetching in useGetUserBuilding hook",
      "acceptanceCriteria": [
        "useGetUserBuilding hook includes refetchOnWindowFocus: false",
        "useGetUserBuilding hook includes refetchOnReconnect: false",
        "useGetUserBuilding hook includes staleTime set to at least 300000ms (5 minutes)",
        "Building query no longer triggers repeatedly in console logs"
      ],
      "file_operations": [
        {
          "path": "frontend/src/hooks/useQueries.ts",
          "operation": "modify",
          "description": "Update the useGetUserBuilding hook's useQuery configuration to add refetchOnWindowFocus: false, refetchOnReconnect: false, and staleTime: 300000 (5 minutes) to prevent unnecessary background refetching"
        }
      ]
    },
    {
      "id": "REQ-99",
      "summary": "Fix onboarding flow state management race condition by deferring clearOnboardingFlow() call",
      "acceptanceCriteria": [
        "Session storage mode persists until the onboarding UI renders successfully",
        "clearOnboardingFlow() is only called after mode state is used for rendering",
        "Onboarding section displays correct UI based on flow type (building-owner, authority, resident)",
        "No race condition between session storage read/write/clear operations"
      ],
      "file_operations": [
        {
          "path": "frontend/src/pages/Home.tsx",
          "operation": "modify",
          "description": "Modify the useEffect hook that handles onboarding flow initialization to defer the clearOnboardingFlow() call until after the mode has been set in local state and the component has rendered at least once with that mode. Use a separate useEffect with mode as a dependency or a setTimeout to ensure the onboarding UI renders before session storage is cleared"
        }
      ]
    },
    {
      "id": "REQ-100",
      "summary": "Add loading state guards in App.tsx to prevent premature rendering during authentication",
      "acceptanceCriteria": [
        "App.tsx checks isLoading state for both profile and building queries before routing",
        "Loading state displayed to user while queries are in progress",
        "Routing decisions only made after query data is available",
        "No blank screens or rapid route switching during authentication"
      ],
      "file_operations": [
        {
          "path": "frontend/src/App.tsx",
          "operation": "modify",
          "description": "Add loading state guards in the ProtectedRoute component and main routing logic to check both profileLoading and buildingLoading states before rendering child routes or making routing decisions. Display a Turkish loading message ('Yükleniyor...') while either query is in progress to prevent blank screens and route flickering"
        }
      ]
    },
    {
      "id": "REQ-101",
      "summary": "Update all list query hooks to disable unnecessary background refetching",
      "acceptanceCriteria": [
        "All list query hooks include refetchOnWindowFocus: false",
        "All list query hooks include refetchOnReconnect: false",
        "Query refetching only occurs when explicitly triggered via mutations or manual refetch",
        "Console logs show reduced query activity"
      ],
      "file_operations": [
        {
          "path": "frontend/src/hooks/useQueries.ts",
          "operation": "modify",
          "description": "Update all list query hooks (useListInviteCodes, useListBuildingUsers, useListApartments, useListAnnouncements, useListIssues) to include refetchOnWindowFocus: false and refetchOnReconnect: false in their useQuery configuration to prevent unnecessary background refetching while preserving cache invalidation logic for mutations"
        }
      ]
    },
    {
      "id": "REQ-102",
      "summary": "Add defensive null/undefined checks in ProtectedRoute component with Turkish error messages",
      "acceptanceCriteria": [
        "ProtectedRoute checks for complete profile data before rendering children",
        "Loading message displayed in Turkish while profile is being fetched",
        "Error message displayed in Turkish if profile fetch fails",
        "No alternating between different UI states"
      ],
      "file_operations": [
        {
          "path": "frontend/src/App.tsx",
          "operation": "modify",
          "description": "Add defensive null/undefined checks in the ProtectedRoute component to verify that userProfile is complete and not null before rendering child components. Display 'Profil yükleniyor...' during loading state and 'Profil verisi alınamadı' if profile fetch fails or data is incomplete, preventing UI state alternation"
        }
      ]
    },
    {
      "id": "REQ-103",
      "summary": "Add fallback session storage check in Home page onboarding section",
      "acceptanceCriteria": [
        "Home page checks session storage if local mode state is null",
        "Correct onboarding UI renders even if initial state setup had timing issues",
        "No empty/default state displayed when user selected a specific flow",
        "Session storage acts as source of truth when local state is missing"
      ],
      "file_operations": [
        {
          "path": "frontend/src/pages/Home.tsx",
          "operation": "modify",
          "description": "Update the onboarding section conditional rendering logic to add a fallback that attempts to retrieve the flow from session storage one more time if the local mode state is null, ensuring the correct onboarding UI renders even when there are timing issues with initial state setup"
        }
      ]
    }
  ]
}